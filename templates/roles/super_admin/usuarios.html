{% extends "base.html" %}
{% block title %}Gesti√≥n de Usuarios - Super Admin{% endblock %}
{% block role_styles %}
<link href="{{ url_for('static', filename='css/roles/super_admin.css') }}" rel="stylesheet">
<style>
    .user-card {
        transition: all 0.3s;
        border-left: 4px solid #667eea;
    }
    .user-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .role-badge {
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
    }
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .btn-create {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
    }
    .btn-create:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .search-box {
        border-radius: 25px;
        border: 2px solid #e2e8f0;
        padding: 12px 20px;
    }
    .search-box:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
</style>
{% endblock %}
{% block body_class %}role-super-admin{% endblock %}
{% block navbar_class %}navbar-dark bg-dark{% endblock %}
{% block brand_text %}Sistema Electoral - Gesti√≥n de Usuarios{% endblock %}

{% block navigation %}
<li class="nav-item">
    <a class="nav-link" href="{{ url_for('dashboard_role', role='super_admin') }}">
        <i class="fas fa-tachometer-alt me-1"></i>Dashboard
    </a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="/super_admin/usuarios">
        <i class="fas fa-users me-1"></i>Usuarios
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="/electoral">
        <i class="fas fa-vote-yea me-1"></i>Procesos Electorales
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="/reports">
        <i class="fas fa-chart-bar me-1"></i>Reportes
    </a>
</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-users me-2"></i>Gesti√≥n de Usuarios</h2>
                    <p class="text-muted mb-0">Administra todos los usuarios del sistema electoral</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-warning btn-lg" onclick="showAutoGenerateModal()">
                        <i class="fas fa-magic me-2"></i>Generar Autom√°tico
                    </button>
                    <button class="btn btn-create btn-lg" onclick="showCreateUserModal()">
                        <i class="fas fa-user-plus me-2"></i>Crear Usuario
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros y b√∫squeda -->
    <div class="row mb-4">
        <div class="col-md-6">
            <input type="text" class="form-control search-box" id="searchInput" placeholder="üîç Buscar por nombre, c√©dula o email..." onkeyup="filterUsers()">
        </div>
        <div class="col-md-3">
            <select class="form-select" id="filterRol" onchange="filterUsers()">
                <option value="">Todos los roles</option>
                <option value="super_admin">Super Admin</option>
                <option value="admin_departamental">Admin Departamental</option>
                <option value="admin_municipal">Admin Municipal</option>
                <option value="coordinador_departamental">Coordinador Departamental</option>
                <option value="coordinador_municipal">Coordinador Municipal</option>
                <option value="coordinador_puesto">Coordinador Puesto</option>
                <option value="testigo_mesa">Testigo Mesa</option>
                <option value="auditor_electoral">Auditor Electoral</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="filterEstado" onchange="filterUsers()">
                <option value="">Todos los estados</option>
                <option value="1">Activos</option>
                <option value="0">Inactivos</option>
            </select>
        </div>
    </div>

    <!-- Estad√≠sticas r√°pidas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <h3 class="text-primary mb-0" id="totalUsers">0</h3>
                    <small class="text-muted">Total Usuarios</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h3 class="text-success mb-0" id="activeUsers">0</h3>
                    <small class="text-muted">Activos</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h3 class="text-warning mb-0" id="testigosCount">0</h3>
                    <small class="text-muted">Testigos</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <h3 class="text-info mb-0" id="coordinadoresCount">0</h3>
                    <small class="text-muted">Coordinadores</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de usuarios -->
    <div class="row" id="usersContainer">
        <!-- Los usuarios se cargar√°n aqu√≠ din√°micamente -->
    </div>
</div>

<!-- Modal Generaci√≥n Autom√°tica -->
<div class="modal fade" id="autoGenerateModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-magic me-2"></i>Generaci√≥n Autom√°tica de Usuarios desde DIVIPOLA
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Generaci√≥n Inteligente:</strong> Este sistema crear√° usuarios autom√°ticamente bas√°ndose en la estructura DIVIPOLA cargada en la base de datos.
                </div>

                <!-- Opciones de generaci√≥n -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card border-primary">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-city text-primary me-2"></i>Coordinadores Municipales
                                </h5>
                                <p class="card-text">Genera un coordinador por cada municipio del departamento</p>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="genCoordinadoresMunicipales" checked>
                                    <label class="form-check-label" for="genCoordinadoresMunicipales">
                                        Generar coordinadores municipales
                                    </label>
                                </div>
                                <small class="text-muted">Se crear√°n <span id="countMunicipios">0</span> usuarios</small>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card border-warning">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-building text-warning me-2"></i>Coordinadores de Puesto
                                </h5>
                                <p class="card-text">Genera un coordinador por cada puesto de votaci√≥n</p>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="genCoordinadoresPuesto" checked>
                                    <label class="form-check-label" for="genCoordinadoresPuesto">
                                        Generar coordinadores de puesto
                                    </label>
                                </div>
                                <small class="text-muted">Se crear√°n <span id="countPuestos">0</span> usuarios</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card border-success">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-user-check text-success me-2"></i>Testigos de Mesa
                                </h5>
                                <p class="card-text">Genera un testigo por cada mesa de votaci√≥n</p>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="genTestigos" checked>
                                    <label class="form-check-label" for="genTestigos">
                                        Generar testigos de mesa
                                    </label>
                                </div>
                                <small class="text-muted">Se crear√°n <span id="countMesas">0</span> usuarios</small>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card border-info">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-cog text-info me-2"></i>Configuraci√≥n
                                </h5>
                                <div class="mb-3">
                                    <label class="form-label">Contrase√±a por defecto</label>
                                    <input type="text" class="form-control" id="defaultPassword" value="Electoral2024!" placeholder="Contrase√±a para todos los usuarios">
                                    <small class="text-muted">Los usuarios podr√°n cambiarla despu√©s</small>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="skipExisting" checked>
                                    <label class="form-check-label" for="skipExisting">
                                        Omitir usuarios existentes
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resumen -->
                <div class="alert alert-dark">
                    <h6><i class="fas fa-calculator me-2"></i>Resumen de Generaci√≥n</h6>
                    <div class="row text-center">
                        <div class="col-md-4">
                            <h3 class="text-primary mb-0" id="totalUsuarios">0</h3>
                            <small>Total de usuarios a crear</small>
                        </div>
                        <div class="col-md-4">
                            <h3 class="text-success mb-0" id="estimatedTime">~0s</h3>
                            <small>Tiempo estimado</small>
                        </div>
                        <div class="col-md-4">
                            <h3 class="text-info mb-0">Caquet√°</h3>
                            <small>Departamento</small>
                        </div>
                    </div>
                </div>

                <!-- Progreso -->
                <div id="generationProgress" style="display: none;">
                    <div class="progress mb-3" style="height: 30px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" id="progressBar" style="width: 0%">
                            <span id="progressText">0%</span>
                        </div>
                    </div>
                    <div id="generationLog" style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.85rem;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="startAutoGeneration()" id="btnStartGeneration">
                    <i class="fas fa-magic me-2"></i>Iniciar Generaci√≥n
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear/Editar Usuario -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">
                    <i class="fas fa-user-plus me-2"></i>Crear Nuevo Usuario
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">C√©dula *</label>
                            <input type="text" class="form-control" id="userCedula" required pattern="[0-9]{6,10}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre Completo *</label>
                            <input type="text" class="form-control" id="userNombre" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Email (Opcional)</label>
                            <input type="email" class="form-control" id="userEmail">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tel√©fono *</label>
                            <input type="tel" class="form-control" id="userTelefono" required pattern="[0-9]{10}">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Rol *</label>
                            <select class="form-select" id="userRol" required onchange="updateUbicacionFields()">
                                <option value="">Seleccione...</option>
                                <option value="super_admin">Super Admin</option>
                                <option value="admin_departamental">Admin Departamental</option>
                                <option value="admin_municipal">Admin Municipal</option>
                                <option value="coordinador_departamental">Coordinador Departamental</option>
                                <option value="coordinador_municipal">Coordinador Municipal</option>
                                <option value="coordinador_puesto">Coordinador Puesto</option>
                                <option value="testigo_mesa">Testigo Mesa</option>
                                <option value="auditor_electoral">Auditor Electoral</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Contrase√±a *</label>
                            <input type="password" class="form-control" id="userPassword" minlength="6">
                            <small class="text-muted">M√≠nimo 6 caracteres</small>
                        </div>
                    </div>

                    <!-- Campos de ubicaci√≥n condicionales seg√∫n rol -->
                    <div id="ubicacionFields">
                        <div class="row" id="departamentoRow" style="display: none;">
                            <div class="col-12 mb-3">
                                <label class="form-label">Departamento *</label>
                                <select class="form-select" id="userDepartamento">
                                    <option value="Caquet√°">Caquet√°</option>
                                </select>
                                <small class="text-muted">Departamento asignado</small>
                            </div>
                        </div>

                        <div class="row" id="municipioRow" style="display: none;">
                            <div class="col-12 mb-3">
                                <label class="form-label">Municipio *</label>
                                <select class="form-select" id="userMunicipio" onchange="loadPuestosModal()">
                                    <option value="">Seleccione...</option>
                                </select>
                            </div>
                        </div>

                        <div class="row" id="puestoRow" style="display: none;">
                            <div class="col-12 mb-3">
                                <label class="form-label">Puesto de Votaci√≥n *</label>
                                <select class="form-select" id="userPuesto" onchange="loadMesasModal()">
                                    <option value="">Seleccione municipio...</option>
                                </select>
                            </div>
                        </div>

                        <div class="row" id="mesaRow" style="display: none;">
                            <div class="col-12 mb-3">
                                <label class="form-label">Mesa *</label>
                                <select class="form-select" id="userMesa">
                                    <option value="">Seleccione puesto...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info" id="ubicacionInfo">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Nota:</strong> Seleccione un rol para ver los campos de ubicaci√≥n requeridos.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-create" onclick="saveUser()">
                    <i class="fas fa-save me-2"></i>Guardar Usuario
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let allUsers = [];
let userModal;
let autoGenerateModal;

document.addEventListener('DOMContentLoaded', function() {
    userModal = new bootstrap.Modal(document.getElementById('userModal'));
    autoGenerateModal = new bootstrap.Modal(document.getElementById('autoGenerateModal'));
    loadUsers();
    loadMunicipiosModal();
    loadGenerationStats();
});

// Cargar usuarios
async function loadUsers() {
    try {
        const response = await fetch('/api/admin/users');
        const data = await response.json();
        
        if (data.success) {
            allUsers = data.users;
            displayUsers(allUsers);
            updateStats(allUsers);
        }
    } catch (error) {
        console.error('Error cargando usuarios:', error);
        alert('Error al cargar usuarios');
    }
}

// Mostrar usuarios
function displayUsers(users) {
    const container = document.getElementById('usersContainer');
    
    if (users.length === 0) {
        container.innerHTML = `
            <div class="col-12">
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    No se encontraron usuarios
                </div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = users.map(user => `
        <div class="col-md-6 col-lg-4 mb-3">
            <div class="card user-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title mb-0">${user.nombre_completo}</h5>
                        <span class="badge ${user.activo ? 'bg-success' : 'bg-secondary'}">
                            ${user.activo ? 'Activo' : 'Inactivo'}
                        </span>
                    </div>
                    
                    <p class="text-muted mb-2">
                        <i class="fas fa-id-card me-2"></i>${user.cedula}
                    </p>
                    
                    <span class="badge role-badge bg-primary mb-2">${getRoleName(user.rol)}</span>
                    
                    ${user.email ? `<p class="text-muted mb-1"><i class="fas fa-envelope me-2"></i>${user.email}</p>` : ''}
                    <p class="text-muted mb-1"><i class="fas fa-phone me-2"></i>${user.telefono}</p>
                    
                    ${user.departamento ? `<p class="text-muted mb-1"><i class="fas fa-map me-2"></i>${user.departamento}</p>` : ''}
                    ${user.municipio_nombre ? `<p class="text-muted mb-1"><i class="fas fa-map-marker-alt me-2"></i>${user.municipio_nombre}</p>` : ''}
                    ${user.puesto_nombre ? `<p class="text-muted mb-1"><i class="fas fa-building me-2"></i>${user.puesto_nombre}</p>` : ''}
                    ${user.mesa_numero ? `<p class="text-muted mb-1"><i class="fas fa-table me-2"></i>Mesa ${user.mesa_numero}</p>` : ''}
                    
                    <div class="mt-3 d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary flex-fill" onclick="editUser(${user.id})">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Actualizar estad√≠sticas
function updateStats(users) {
    document.getElementById('totalUsers').textContent = users.length;
    document.getElementById('activeUsers').textContent = users.filter(u => u.activo).length;
    document.getElementById('testigosCount').textContent = users.filter(u => u.rol === 'testigo_mesa').length;
    document.getElementById('coordinadoresCount').textContent = users.filter(u => u.rol.includes('coordinador')).length;
}

// Filtrar usuarios
function filterUsers() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const rolFilter = document.getElementById('filterRol').value;
    const estadoFilter = document.getElementById('filterEstado').value;
    
    let filtered = allUsers;
    
    if (searchTerm) {
        filtered = filtered.filter(u => 
            u.nombre_completo.toLowerCase().includes(searchTerm) ||
            u.cedula.includes(searchTerm) ||
            (u.email && u.email.toLowerCase().includes(searchTerm))
        );
    }
    
    if (rolFilter) {
        filtered = filtered.filter(u => u.rol === rolFilter);
    }
    
    if (estadoFilter !== '') {
        filtered = filtered.filter(u => u.activo == estadoFilter);
    }
    
    displayUsers(filtered);
}

// Mostrar modal crear usuario
function showCreateUserModal() {
    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-plus me-2"></i>Crear Nuevo Usuario';
    document.getElementById('userForm').reset();
    document.getElementById('userId').value = '';
    document.getElementById('userPassword').required = true;
    
    // Ocultar todos los campos de ubicaci√≥n
    document.getElementById('departamentoRow').style.display = 'none';
    document.getElementById('municipioRow').style.display = 'none';
    document.getElementById('puestoRow').style.display = 'none';
    document.getElementById('mesaRow').style.display = 'none';
    
    // Resetear info
    document.getElementById('ubicacionInfo').innerHTML = `
        <i class="fas fa-info-circle me-2"></i>
        <strong>Nota:</strong> Seleccione un rol para ver los campos de ubicaci√≥n requeridos.
    `;
    document.getElementById('ubicacionInfo').className = 'alert alert-info';
    
    userModal.show();
}

// Editar usuario
async function editUser(userId) {
    const user = allUsers.find(u => u.id === userId);
    if (!user) return;
    
    document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-edit me-2"></i>Editar Usuario';
    document.getElementById('userId').value = user.id;
    document.getElementById('userCedula').value = user.cedula;
    document.getElementById('userNombre').value = user.nombre_completo;
    document.getElementById('userEmail').value = user.email || '';
    document.getElementById('userTelefono').value = user.telefono;
    document.getElementById('userRol').value = user.rol;
    document.getElementById('userPassword').required = false;
    document.getElementById('userPassword').value = '';
    
    userModal.show();
}

// Guardar usuario
async function saveUser() {
    const userId = document.getElementById('userId').value;
    const isEdit = userId !== '';
    
    const userData = {
        cedula: document.getElementById('userCedula').value,
        nombre_completo: document.getElementById('userNombre').value,
        email: document.getElementById('userEmail').value,
        telefono: document.getElementById('userTelefono').value,
        rol: document.getElementById('userRol').value,
        departamento: document.getElementById('userDepartamento').value || null,
        municipio_id: document.getElementById('userMunicipio').value || null,
        puesto_id: document.getElementById('userPuesto').value || null,
        mesa_id: document.getElementById('userMesa').value || null
    };
    
    const password = document.getElementById('userPassword').value;
    if (password) {
        userData.password = password;
    } else if (!isEdit) {
        alert('La contrase√±a es requerida para nuevos usuarios');
        return;
    }
    
    try {
        const url = isEdit ? `/api/admin/users/${userId}` : '/api/admin/users';
        const method = isEdit ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(userData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(isEdit ? 'Usuario actualizado exitosamente' : 'Usuario creado exitosamente');
            userModal.hide();
            loadUsers();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error guardando usuario:', error);
        alert('Error al guardar usuario');
    }
}

// Eliminar usuario
async function deleteUser(userId) {
    if (!confirm('¬øEst√° seguro de desactivar este usuario?')) return;
    
    try {
        const response = await fetch(`/api/admin/users/${userId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Usuario desactivado exitosamente');
            loadUsers();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error eliminando usuario:', error);
        alert('Error al eliminar usuario');
    }
}

// Cargar municipios para el modal
async function loadMunicipiosModal() {
    try {
        const response = await fetch('/api/ubicacion/municipios');
        const data = await response.json();
        
        const select = document.getElementById('userMunicipio');
        select.innerHTML = '<option value="">Seleccione...</option>';
        
        data.municipios.forEach(mun => {
            const option = document.createElement('option');
            option.value = mun.id;
            option.textContent = mun.nombre;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error cargando municipios:', error);
    }
}

// Cargar puestos para el modal
async function loadPuestosModal() {
    const municipioId = document.getElementById('userMunicipio').value;
    const selectPuesto = document.getElementById('userPuesto');
    const selectMesa = document.getElementById('userMesa');
    
    selectPuesto.innerHTML = '<option value="">Cargando...</option>';
    selectMesa.innerHTML = '<option value="">Seleccione puesto...</option>';
    
    if (!municipioId) {
        selectPuesto.innerHTML = '<option value="">Seleccione municipio...</option>';
        return;
    }
    
    try {
        const response = await fetch(`/api/ubicacion/puestos-municipio/${municipioId}`);
        const data = await response.json();
        
        selectPuesto.innerHTML = '<option value="">Seleccione...</option>';
        
        data.puestos.forEach(puesto => {
            const option = document.createElement('option');
            option.value = puesto.id;
            option.textContent = puesto.nombre;
            selectPuesto.appendChild(option);
        });
    } catch (error) {
        console.error('Error cargando puestos:', error);
    }
}

// Cargar mesas para el modal
async function loadMesasModal() {
    const puestoId = document.getElementById('userPuesto').value;
    const selectMesa = document.getElementById('userMesa');
    
    selectMesa.innerHTML = '<option value="">Cargando...</option>';
    
    if (!puestoId) {
        selectMesa.innerHTML = '<option value="">Seleccione puesto...</option>';
        return;
    }
    
    try {
        const response = await fetch(`/api/ubicacion/mesas/${puestoId}`);
        const data = await response.json();
        
        selectMesa.innerHTML = '<option value="">Seleccione...</option>';
        
        data.mesas.forEach(mesa => {
            const option = document.createElement('option');
            option.value = mesa.id;
            option.textContent = `Mesa ${mesa.numero}`;
            selectMesa.appendChild(option);
        });
    } catch (error) {
        console.error('Error cargando mesas:', error);
    }
}

// Obtener nombre del rol
function getRoleName(rol) {
    const roles = {
        'super_admin': 'Super Admin',
        'admin_departamental': 'Admin Departamental',
        'admin_municipal': 'Admin Municipal',
        'coordinador_departamental': 'Coordinador Departamental',
        'coordinador_municipal': 'Coordinador Municipal',
        'coordinador_puesto': 'Coordinador Puesto',
        'testigo_mesa': 'Testigo Mesa',
        'auditor_electoral': 'Auditor Electoral'
    };
    return roles[rol] || rol;
}

// Mostrar modal de generaci√≥n autom√°tica
function showAutoGenerateModal() {
    loadGenerationStats();
    autoGenerateModal.show();
}

// Cargar estad√≠sticas para generaci√≥n
async function loadGenerationStats() {
    try {
        const response = await fetch('/api/admin/generation-stats');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('countMunicipios').textContent = data.municipios;
            document.getElementById('countPuestos').textContent = data.puestos;
            document.getElementById('countMesas').textContent = data.mesas;
            updateTotalUsuarios();
        }
    } catch (error) {
        console.error('Error cargando estad√≠sticas:', error);
    }
}

// Actualizar total de usuarios a crear
function updateTotalUsuarios() {
    let total = 0;
    
    if (document.getElementById('genCoordinadoresMunicipales').checked) {
        total += parseInt(document.getElementById('countMunicipios').textContent);
    }
    if (document.getElementById('genCoordinadoresPuesto').checked) {
        total += parseInt(document.getElementById('countPuestos').textContent);
    }
    if (document.getElementById('genTestigos').checked) {
        total += parseInt(document.getElementById('countMesas').textContent);
    }
    
    document.getElementById('totalUsuarios').textContent = total;
    document.getElementById('estimatedTime').textContent = `~${Math.ceil(total / 10)}s`;
}

// Agregar listeners para actualizar totales
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = ['genCoordinadoresMunicipales', 'genCoordinadoresPuesto', 'genTestigos'];
    checkboxes.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
            checkbox.addEventListener('change', updateTotalUsuarios);
        }
    });
});

// Iniciar generaci√≥n autom√°tica
async function startAutoGeneration() {
    const config = {
        coordinadores_municipales: document.getElementById('genCoordinadoresMunicipales').checked,
        coordinadores_puesto: document.getElementById('genCoordinadoresPuesto').checked,
        testigos: document.getElementById('genTestigos').checked,
        default_password: document.getElementById('defaultPassword').value,
        skip_existing: document.getElementById('skipExisting').checked
    };
    
    if (!config.default_password) {
        alert('Por favor ingrese una contrase√±a por defecto');
        return;
    }
    
    if (!config.coordinadores_municipales && !config.coordinadores_puesto && !config.testigos) {
        alert('Por favor seleccione al menos un tipo de usuario para generar');
        return;
    }
    
    // Confirmar
    const total = parseInt(document.getElementById('totalUsuarios').textContent);
    if (!confirm(`¬øEst√° seguro de generar ${total} usuarios autom√°ticamente?`)) {
        return;
    }
    
    // Mostrar progreso
    document.getElementById('generationProgress').style.display = 'block';
    document.getElementById('btnStartGeneration').disabled = true;
    document.getElementById('progressBar').style.width = '0%';
    document.getElementById('progressText').textContent = '0%';
    document.getElementById('generationLog').innerHTML = '<div class="text-info">Iniciando generaci√≥n...</div>';
    
    try {
        const response = await fetch('/api/admin/generate-users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Actualizar progreso
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('progressText').textContent = '100%';
            document.getElementById('progressBar').classList.remove('progress-bar-animated');
            document.getElementById('progressBar').classList.add('bg-success');
            
            // Mostrar resumen
            let logHtml = '<div class="text-success mb-2"><strong>‚úÖ Generaci√≥n completada exitosamente</strong></div>';
            logHtml += `<div>üìä Total creados: ${data.created}</div>`;
            logHtml += `<div>‚è≠Ô∏è Omitidos (ya exist√≠an): ${data.skipped}</div>`;
            logHtml += `<div>‚ùå Errores: ${data.errors}</div>`;
            
            if (data.details) {
                logHtml += '<div class="mt-2"><strong>Detalles:</strong></div>';
                data.details.forEach(detail => {
                    const icon = detail.status === 'created' ? '‚úÖ' : detail.status === 'skipped' ? '‚è≠Ô∏è' : '‚ùå';
                    logHtml += `<div class="text-muted">${icon} ${detail.message}</div>`;
                });
            }
            
            document.getElementById('generationLog').innerHTML = logHtml;
            
            // Recargar lista de usuarios
            setTimeout(() => {
                loadUsers();
                alert(`Generaci√≥n completada:\n${data.created} usuarios creados\n${data.skipped} omitidos\n${data.errors} errores`);
                autoGenerateModal.hide();
                document.getElementById('btnStartGeneration').disabled = false;
                document.getElementById('generationProgress').style.display = 'none';
            }, 2000);
        } else {
            throw new Error(data.error || 'Error en la generaci√≥n');
        }
    } catch (error) {
        console.error('Error en generaci√≥n autom√°tica:', error);
        document.getElementById('progressBar').classList.add('bg-danger');
        document.getElementById('generationLog').innerHTML = `<div class="text-danger">‚ùå Error: ${error.message}</div>`;
        document.getElementById('btnStartGeneration').disabled = false;
    }
}

// Actualizar campos de ubicaci√≥n seg√∫n el rol seleccionado
function updateUbicacionFields() {
    const rol = document.getElementById('userRol').value;
    
    // Ocultar todos los campos primero
    document.getElementById('departamentoRow').style.display = 'none';
    document.getElementById('municipioRow').style.display = 'none';
    document.getElementById('puestoRow').style.display = 'none';
    document.getElementById('mesaRow').style.display = 'none';
    
    // Remover required de todos
    document.getElementById('userDepartamento').required = false;
    document.getElementById('userMunicipio').required = false;
    document.getElementById('userPuesto').required = false;
    document.getElementById('userMesa').required = false;
    
    // Configurar seg√∫n el rol
    const ubicacionInfo = document.getElementById('ubicacionInfo');
    
    switch(rol) {
        case 'super_admin':
            ubicacionInfo.innerHTML = `
                <i class="fas fa-crown me-2"></i>
                <strong>Super Admin:</strong> No requiere asignaci√≥n de ubicaci√≥n espec√≠fica. Tiene acceso total al sistema.
            `;
            ubicacionInfo.className = 'alert alert-dark';
            break;
            
        case 'admin_departamental':
        case 'coordinador_departamental':
            document.getElementById('departamentoRow').style.display = 'block';
            document.getElementById('userDepartamento').required = true;
            ubicacionInfo.innerHTML = `
                <i class="fas fa-map me-2"></i>
                <strong>${getRoleName(rol)}:</strong> Requiere asignaci√≥n de departamento.
            `;
            ubicacionInfo.className = 'alert alert-primary';
            break;
            
        case 'admin_municipal':
        case 'coordinador_municipal':
            document.getElementById('departamentoRow').style.display = 'block';
            document.getElementById('municipioRow').style.display = 'block';
            document.getElementById('userDepartamento').required = true;
            document.getElementById('userMunicipio').required = true;
            ubicacionInfo.innerHTML = `
                <i class="fas fa-city me-2"></i>
                <strong>${getRoleName(rol)}:</strong> Requiere asignaci√≥n de departamento y municipio.
            `;
            ubicacionInfo.className = 'alert alert-info';
            break;
            
        case 'coordinador_puesto':
            document.getElementById('departamentoRow').style.display = 'block';
            document.getElementById('municipioRow').style.display = 'block';
            document.getElementById('puestoRow').style.display = 'block';
            document.getElementById('userDepartamento').required = true;
            document.getElementById('userMunicipio').required = true;
            document.getElementById('userPuesto').required = true;
            ubicacionInfo.innerHTML = `
                <i class="fas fa-building me-2"></i>
                <strong>Coordinador de Puesto:</strong> Requiere asignaci√≥n de departamento, municipio y puesto de votaci√≥n.
            `;
            ubicacionInfo.className = 'alert alert-warning';
            break;
            
        case 'testigo_mesa':
            document.getElementById('departamentoRow').style.display = 'block';
            document.getElementById('municipioRow').style.display = 'block';
            document.getElementById('puestoRow').style.display = 'block';
            document.getElementById('mesaRow').style.display = 'block';
            document.getElementById('userDepartamento').required = true;
            document.getElementById('userMunicipio').required = true;
            document.getElementById('userPuesto').required = true;
            document.getElementById('userMesa').required = true;
            ubicacionInfo.innerHTML = `
                <i class="fas fa-user-check me-2"></i>
                <strong>Testigo de Mesa:</strong> Requiere asignaci√≥n completa: departamento, municipio, puesto y mesa espec√≠fica.
            `;
            ubicacionInfo.className = 'alert alert-success';
            break;
            
        case 'auditor_electoral':
            document.getElementById('departamentoRow').style.display = 'block';
            document.getElementById('userDepartamento').required = true;
            ubicacionInfo.innerHTML = `
                <i class="fas fa-search me-2"></i>
                <strong>Auditor Electoral:</strong> Requiere asignaci√≥n de departamento.
            `;
            ubicacionInfo.className = 'alert alert-danger';
            break;
            
        default:
            ubicacionInfo.innerHTML = `
                <i class="fas fa-info-circle me-2"></i>
                <strong>Nota:</strong> Seleccione un rol para ver los campos de ubicaci√≥n requeridos.
            `;
            ubicacionInfo.className = 'alert alert-info';
    }
}
</script>
{% endblock %}
