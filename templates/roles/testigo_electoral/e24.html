{% extends "base.html" %}
{% block title %}Captura E24 - Testigo Electoral{% endblock %}
{% block role_styles %}
<link href="{{ url_for('static', filename='css/roles/testigo_electoral.css') }}" rel="stylesheet">
<style>
.e24-info {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
}
.photo-zoom-container {
    position: relative;
    max-width: 100%;
    max-height: 400px;
    overflow: hidden;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    background: #000;
}
.photo-preview {
    max-width: 100%;
    max-height: 400px;
    display: block;
    margin: 0 auto;
    user-select: none;
    transition: transform 0.3s ease;
    transform-origin: center;
}
.zoom-controls {
    opacity: 0.8;
    transition: opacity 0.3s ease;
}
.zoom-controls:hover {
    opacity: 1;
}
</style>
{% endblock %}
{% block body_class %}role-testigo-electoral{% endblock %}
{% block navbar_class %}navbar-dark bg-success{% endblock %}
{% block brand_text %}Sistema Electoral - Captura E24{% endblock %}
{% block navigation %}
<li class="nav-item">
    <a class="nav-link" href="/dashboard/testigo_electoral">
        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="/testigo/e14">
        <i class="fas fa-camera me-2"></i>Capturar E14
    </a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="/testigo/e24">
        <i class="fas fa-clipboard-check me-2"></i>Capturar E24
    </a>
</li>
{% endblock %}
{% block content %}
<div class="container-fluid">
    <!-- Header con información -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="e24-info">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h3><i class="fas fa-clipboard-check me-2"></i>Captura del Formulario E24</h3>
                        <p class="mb-0">Capture una foto clara del formulario E24 (Acta de Instalación) para documentar la instalación y apertura de la mesa electoral.</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="d-flex align-items-center justify-content-end">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            <div>
                                <strong>Mesa:</strong> <span id="mesa-info">Cargando...</span><br>
                                <strong>Puesto:</strong> <span id="puesto-info">Cargando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Selector de Mesa -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>
                        Seleccionar Mesa Electoral
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Mesa para E24:</label>
                            <select class="form-select" id="mesa-selector" onchange="seleccionarMesa()">
                                <option value="">Seleccione una mesa...</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div id="mesa-status" class="mt-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Área de captura -->
    <div class="row" id="capture-area" style="display: none;">
        <div class="col-lg-8 col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-camera me-2"></i>
                        Captura de E24 - Mesa <span id="selected-mesa-number"></span>
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Cámara -->
                    <div class="camera-container" id="camera-container">
                        <video id="camera-preview" class="camera-preview" autoplay playsinline></video>
                        <div class="camera-controls">
                            <button class="btn btn-secondary" onclick="switchCamera()" title="Cambiar cámara">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="capture-btn" onclick="capturePhoto()" title="Capturar foto">
                                <i class="fas fa-camera fa-2x"></i>
                            </button>
                            <button class="btn btn-secondary" onclick="toggleFlash()" title="Flash">
                                <i class="fas fa-bolt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Vista previa con zoom -->
                    <div class="photo-preview-container" id="photo-preview-container">
                        <div class="photo-zoom-container">
                            <img id="photo-preview" class="photo-preview" alt="Vista previa de E24">
                            
                            <!-- Controles de zoom -->
                            <div class="zoom-controls" style="position: absolute; top: 10px; right: 10px; display: flex; flex-direction: column; gap: 5px;">
                                <button class="btn btn-sm btn-light" onclick="zoomIn()" title="Acercar">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="btn btn-sm btn-light" onclick="zoomOut()" title="Alejar">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button class="btn btn-sm btn-light" onclick="resetZoom()" title="Restablecer">
                                    <i class="fas fa-expand-arrows-alt"></i>
                                </button>
                                <button class="btn btn-sm btn-success" onclick="fullscreenPreview()" title="Pantalla completa">
                                    <i class="fas fa-expand"></i>
                                </button>
                            </div>
                            
                            <!-- Indicador de zoom -->
                            <div class="zoom-indicator" style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem;">
                                <span id="zoom-level">100%</span>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button class="btn btn-secondary me-2" onclick="retakePhoto()">
                                <i class="fas fa-redo me-2"></i>Tomar Otra Foto
                            </button>
                            <button class="btn btn-success" onclick="confirmPhoto()">
                                <i class="fas fa-check me-2"></i>Confirmar Foto
                            </button>
                        </div>
                    </div>
                    
                    <!-- Zona de subida alternativa -->
                    <div class="upload-zone mt-3" id="upload-zone" onclick="document.getElementById('file-input').click()">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                        <h5>¿No puedes usar la cámara?</h5>
                        <p class="text-muted">Haz clic aquí para subir una foto desde tu galería</p>
                        <input type="file" id="file-input" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 col-md-12">
            <!-- Instrucciones -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Instrucciones E24
                    </h5>
                </div>
                <div class="card-body">
                    <div class="instruction-step">
                        <div class="d-flex align-items-start mb-3">
                            <div class="badge bg-success rounded-pill me-3">1</div>
                            <div>
                                <strong>Momento de captura</strong><br>
                                <small class="text-muted">Capture el E24 al momento de la instalación de la mesa</small>
                            </div>
                        </div>
                    </div>
                    <div class="instruction-step">
                        <div class="d-flex align-items-start mb-3">
                            <div class="badge bg-success rounded-pill me-3">2</div>
                            <div>
                                <strong>Información completa</strong><br>
                                <small class="text-muted">Asegúrese de capturar toda la información del acta</small>
                            </div>
                        </div>
                    </div>
                    <div class="instruction-step">
                        <div class="d-flex align-items-start mb-3">
                            <div class="badge bg-success rounded-pill me-3">3</div>
                            <div>
                                <strong>Firmas visibles</strong><br>
                                <small class="text-muted">Verifique que todas las firmas sean legibles</small>
                            </div>
                        </div>
                    </div>
                    <div class="instruction-step">
                        <div class="d-flex align-items-start">
                            <div class="badge bg-success rounded-pill me-3">4</div>
                            <div>
                                <strong>Use el zoom</strong><br>
                                <small class="text-muted">Utilice los controles de zoom para verificar detalles</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Información del E24 -->
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-check me-2"></i>
                        Acta de Instalación E24
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Hora de instalación de la mesa
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Nombres de jurados presentes
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Firmas de funcionarios
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Observaciones de instalación
                        </li>
                        <li>
                            <i class="fas fa-check text-success me-2"></i>
                            Sello oficial de la mesa
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block role_scripts %}
<script>
// Reutilizar las mismas funciones de zoom del E14
let currentStream = null;
let capturedPhoto = null;
let zoomLevel = 1;
let isDragging = false;
let startX, startY, translateX = 0, translateY = 0;
let currentUserId = 5;
let currentPuestoId = null;
let selectedMesaId = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log('Página de captura E24 cargada');
    cargarInformacionUbicacion();
    cargarMesasDisponibles();
});

function cargarInformacionUbicacion() {
    fetch(`/api/user/location/${currentUserId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const location = data.location;
            document.getElementById('puesto-info').textContent = location.puesto || 'N/A';
            currentPuestoId = location.puesto_id || 1;
        }
    })
    .catch(error => console.error('Error:', error));
}

function cargarMesasDisponibles() {
    if (!currentPuestoId) {
        setTimeout(cargarMesasDisponibles, 1000);
        return;
    }
    
    fetch(`/api/mesas/puesto/${currentPuestoId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const selector = document.getElementById('mesa-selector');
            selector.innerHTML = '<option value="">Seleccione una mesa...</option>';
            
            data.mesas.forEach(mesa => {
                const option = document.createElement('option');
                option.value = mesa.id;
                option.textContent = `Mesa ${mesa.numero}`;
                selector.appendChild(option);
            });
        }
    })
    .catch(error => console.error('Error cargando mesas:', error));
}

function seleccionarMesa() {
    const selector = document.getElementById('mesa-selector');
    const mesaId = selector.value;
    const mesaText = selector.options[selector.selectedIndex].text;
    
    if (!mesaId) {
        document.getElementById('capture-area').style.display = 'none';
        return;
    }
    
    selectedMesaId = mesaId;
    document.getElementById('capture-area').style.display = 'block';
    document.getElementById('selected-mesa-number').textContent = mesaText.split(' ')[1];
    
    initializeCamera();
    showNotification('Mesa seleccionada. Puede proceder con la captura del E24.', 'success');
}

// Incluir todas las funciones de zoom del E14
async function initializeCamera() {
    try {
        const constraints = {
            video: {
                facingMode: 'environment',
                width: { ideal: 1920 },
                height: { ideal: 1080 }
            }
        };
        
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        const video = document.getElementById('camera-preview');
        video.srcObject = currentStream;
        
        showNotification('Cámara inicializada correctamente', 'success');
    } catch (error) {
        console.error('Error accediendo a la cámara:', error);
        showNotification('No se pudo acceder a la cámara. Use la opción de subir archivo.', 'warning');
    }
}

function capturePhoto() {
    const video = document.getElementById('camera-preview');
    const canvas = document.createElement('canvas');
    const context = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);
    
    capturedPhoto = canvas.toDataURL('image/jpeg', 0.9);
    showPhotoPreview(capturedPhoto);
}

function showPhotoPreview(imageSrc) {
    document.getElementById('camera-container').style.display = 'none';
    document.getElementById('photo-preview-container').style.display = 'block';
    
    const previewImg = document.getElementById('photo-preview');
    previewImg.src = imageSrc;
    
    resetZoom();
    setupZoomAndPan();
}

function retakePhoto() {
    document.getElementById('camera-container').style.display = 'block';
    document.getElementById('photo-preview-container').style.display = 'none';
    capturedPhoto = null;
    resetZoom();
}

function confirmPhoto() {
    if (capturedPhoto) {
        showNotification('E24 capturado exitosamente', 'success');
        // Aquí se enviaría el E24 al servidor
        setTimeout(() => {
            window.location.href = '/testigo/resultados';
        }, 2000);
    }
}

// Funciones de zoom (copiadas del E14)
function setupZoomAndPan() {
    const previewImg = document.getElementById('photo-preview');
    
    previewImg.addEventListener('wheel', function(e) {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        zoomLevel = Math.max(0.5, Math.min(5, zoomLevel + delta));
        updateZoom();
    });
    
    previewImg.addEventListener('mousedown', startDrag);
    previewImg.addEventListener('touchstart', startDrag);
    
    document.addEventListener('mousemove', drag);
    document.addEventListener('touchmove', drag);
    
    document.addEventListener('mouseup', endDrag);
    document.addEventListener('touchend', endDrag);
    
    previewImg.addEventListener('dblclick', function() {
        if (zoomLevel === 1) {
            zoomLevel = 2;
        } else {
            resetZoom();
        }
        updateZoom();
    });
}

function startDrag(e) {
    if (zoomLevel <= 1) return;
    
    isDragging = true;
    const clientX = e.clientX || e.touches[0].clientX;
    const clientY = e.clientY || e.touches[0].clientY;
    
    startX = clientX - translateX;
    startY = clientY - translateY;
    
    document.getElementById('photo-preview').style.cursor = 'grabbing';
}

function drag(e) {
    if (!isDragging || zoomLevel <= 1) return;
    
    e.preventDefault();
    const clientX = e.clientX || e.touches[0].clientX;
    const clientY = e.clientY || e.touches[0].clientY;
    
    translateX = clientX - startX;
    translateY = clientY - startY;
    
    updateZoom();
}

function endDrag() {
    isDragging = false;
    document.getElementById('photo-preview').style.cursor = zoomLevel > 1 ? 'grab' : 'zoom-in';
}

function zoomIn() {
    zoomLevel = Math.min(5, zoomLevel + 0.25);
    updateZoom();
}

function zoomOut() {
    zoomLevel = Math.max(0.5, zoomLevel - 0.25);
    if (zoomLevel <= 1) {
        translateX = 0;
        translateY = 0;
    }
    updateZoom();
}

function resetZoom() {
    zoomLevel = 1;
    translateX = 0;
    translateY = 0;
    updateZoom();
}

function updateZoom() {
    const previewImg = document.getElementById('photo-preview');
    previewImg.style.transform = `scale(${zoomLevel}) translate(${translateX/zoomLevel}px, ${translateY/zoomLevel}px)`;
    previewImg.style.cursor = zoomLevel > 1 ? 'grab' : 'zoom-in';
    
    document.getElementById('zoom-level').textContent = Math.round(zoomLevel * 100) + '%';
}

function fullscreenPreview() {
    const previewImg = document.getElementById('photo-preview');
    
    const modalContent = `
        <div class="fullscreen-preview" style="position: relative; height: 80vh;">
            <img src="${previewImg.src}" id="fullscreen-img" 
                 style="width: 100%; height: 100%; object-fit: contain; cursor: zoom-in;">
            
            <div class="fullscreen-controls" style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px;">
                <button class="btn btn-light" onclick="fullscreenZoomIn()">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="btn btn-light" onclick="fullscreenZoomOut()">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="btn btn-light" onclick="fullscreenReset()">
                    <i class="fas fa-expand-arrows-alt"></i>
                </button>
            </div>
            
            <div class="fullscreen-zoom-indicator" style="position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.7); color: white; padding: 10px 15px; border-radius: 20px;">
                <span id="fullscreen-zoom-level">100%</span>
            </div>
        </div>
    `;
    
    mostrarModal('Vista Previa E24 - Pantalla Completa', modalContent);
    
    setTimeout(() => {
        setupFullscreenZoom();
    }, 500);
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            capturedPhoto = e.target.result;
            showPhotoPreview(capturedPhoto);
        };
        reader.readAsDataURL(file);
    }
}

function switchCamera() {
    showNotification('Cambiando cámara...', 'info');
}

function toggleFlash() {
    showNotification('Flash activado/desactivado', 'info');
}

function showNotification(mensaje, tipo = 'info') {
    const alertClass = {
        'success': 'alert-success',
        'warning': 'alert-warning',
        'error': 'alert-danger',
        'info': 'alert-info'
    }[tipo];
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    notification.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// Funciones adicionales de zoom en pantalla completa (simplificadas)
let fullscreenZoom = 1;

function setupFullscreenZoom() {
    const fullscreenImg = document.getElementById('fullscreen-img');
    if (!fullscreenImg) return;
    
    fullscreenImg.addEventListener('wheel', function(e) {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        fullscreenZoom = Math.max(0.5, Math.min(5, fullscreenZoom + delta));
        updateFullscreenZoom();
    });
}

function fullscreenZoomIn() {
    fullscreenZoom = Math.min(5, fullscreenZoom + 0.25);
    updateFullscreenZoom();
}

function fullscreenZoomOut() {
    fullscreenZoom = Math.max(0.5, fullscreenZoom - 0.25);
    updateFullscreenZoom();
}

function fullscreenReset() {
    fullscreenZoom = 1;
    updateFullscreenZoom();
}

function updateFullscreenZoom() {
    const fullscreenImg = document.getElementById('fullscreen-img');
    if (!fullscreenImg) return;
    
    fullscreenImg.style.transform = `scale(${fullscreenZoom})`;
    
    const indicator = document.getElementById('fullscreen-zoom-level');
    if (indicator) {
        indicator.textContent = Math.round(fullscreenZoom * 100) + '%';
    }
}

function mostrarModal(titulo, contenido) {
    const modalHtml = `
        <div class="modal fade" id="previewModal" tabindex="-1">
            <div class="modal-dialog modal-fullscreen">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">${titulo}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-0">
                        ${contenido}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const existingModal = document.getElementById('previewModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
}

window.addEventListener('beforeunload', function() {
    if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
    }
});
</script>
{% endblock %}