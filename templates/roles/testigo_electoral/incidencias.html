{% extends "base.html" %}
{% block title %}Incidencias - Testigo Electoral{% endblock %}
{% block role_styles %}
<link href="{{ url_for('static', filename='css/roles/testigo_electoral.css') }}" rel="stylesheet">
<style>
.incidencia-form {
    background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 100%);
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    border-left: 5px solid #f59e0b;
}
.urgency-selector {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}
.urgency-option {
    padding: 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
}
.urgency-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.urgency-option.selected {
    border-color: #dc2626;
    background: #fee2e2;
}
.emergency-alert {
    background: linear-gradient(135deg, #fecaca 0%, #f87171 100%);
    border: 2px solid #dc2626;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    color: #7f1d1d;
}
.quick-incident-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}
.quick-incident-btn {
    padding: 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}
.quick-incident-btn:hover {
    border-color: #dc2626;
    background: #fef2f2;
}
.incident-timeline {
    max-height: 400px;
    overflow-y: auto;
}
</style>
{% endblock %}
{% block body_class %}role-testigo-electoral{% endblock %}
{% block navbar_class %}navbar-dark bg-danger{% endblock %}
{% block brand_text %}Sistema Electoral - Incidencias{% endblock %}
{% block navigation %}
<li class="nav-item">
    <a class="nav-link" href="/dashboard/testigo_electoral">
        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="/testigo/observacion">
        <i class="fas fa-eye me-2"></i>Observaciones
    </a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="/testigo/incidencias">
        <i class="fas fa-exclamation-triangle me-2"></i>Incidencias
    </a>
</li>
<li class="nav-item">
    <a class="nav-link" href="/testigo/resultados">
        <i class="fas fa-chart-bar me-2"></i>Resultados
    </a>
</li>
{% endblock %}
{% block content %}
<div class="container-fluid">
    <!-- Alerta de Emergencia -->
    <div class="emergency-alert" id="emergency-alert" style="display: none;">
        <div class="d-flex align-items-center">
            <i class="fas fa-exclamation-triangle fa-3x me-3"></i>
            <div>
                <h5 class="mb-1">¡INCIDENCIA CRÍTICA DETECTADA!</h5>
                <p class="mb-0">Se ha reportado una incidencia de alta prioridad. Los coordinadores han sido notificados automáticamente.</p>
            </div>
            <button class="btn btn-outline-danger ms-auto" onclick="dismissEmergencyAlert()">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h4 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Reporte de Incidencias Electorales
                    </h4>
                </div>
                <div class="card-body">
                    <p class="mb-0">Reporte inmediatamente cualquier irregularidad, problema o situación que afecte el normal desarrollo del proceso electoral.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Botones de Incidencias Rápidas -->
    <div class="row mb-4">
        <div class="col-12">
            <h5 class="mb-3">
                <i class="fas fa-bolt me-2"></i>
                Incidencias Frecuentes (Reporte Rápido)
            </h5>
            <div class="quick-incident-buttons">
                <div class="quick-incident-btn" onclick="reporteRapido('falla_tecnica')">
                    <i class="fas fa-laptop-code fa-2x text-danger mb-2"></i>
                    <h6>Falla Técnica</h6>
                    <small>Problemas con equipos o sistemas</small>
                </div>
                <div class="quick-incident-btn" onclick="reporteRapido('irregularidad_votacion')">
                    <i class="fas fa-vote-yea fa-2x text-warning mb-2"></i>
                    <h6>Irregularidad en Votación</h6>
                    <small>Problemas en el proceso de voto</small>
                </div>
                <div class="quick-incident-btn" onclick="reporteRapido('problema_seguridad')">
                    <i class="fas fa-shield-alt fa-2x text-danger mb-2"></i>
                    <h6>Problema de Seguridad</h6>
                    <small>Situaciones que comprometen la seguridad</small>
                </div>
                <div class="quick-incident-btn" onclick="reporteRapido('alteracion_orden')">
                    <i class="fas fa-users fa-2x text-warning mb-2"></i>
                    <h6>Alteración del Orden</h6>
                    <small>Disturbios o comportamientos inadecuados</small>
                </div>
                <div class="quick-incident-btn" onclick="reporteRapido('material_faltante')">
                    <i class="fas fa-box fa-2x text-info mb-2"></i>
                    <h6>Material Faltante</h6>
                    <small>Ausencia de materiales necesarios</small>
                </div>
                <div class="quick-incident-btn" onclick="reporteRapido('otro')">
                    <i class="fas fa-plus-circle fa-2x text-secondary mb-2"></i>
                    <h6>Otra Incidencia</h6>
                    <small>Situación no contemplada</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario Detallado de Incidencia -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="incidencia-form">
                <h5 class="mb-4">
                    <i class="fas fa-edit me-2"></i>
                    Reporte Detallado de Incidencia
                </h5>
                
                <form id="incidencia-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Tipo de Incidencia</label>
                                <select class="form-select" id="tipo-incidencia" required>
                                    <option value="">Seleccione el tipo...</option>
                                    <option value="falla_tecnica">Falla Técnica</option>
                                    <option value="irregularidad_votacion">Irregularidad en Votación</option>
                                    <option value="problema_seguridad">Problema de Seguridad</option>
                                    <option value="alteracion_orden">Alteración del Orden Público</option>
                                    <option value="material_faltante">Material Faltante o Defectuoso</option>
                                    <option value="comportamiento_inadecuado">Comportamiento Inadecuado de Funcionarios</option>
                                    <option value="intento_fraude">Intento de Fraude</option>
                                    <option value="violacion_secreto">Violación del Secreto del Voto</option>
                                    <option value="coaccion_votante">Coacción a Votantes</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Mesa Afectada</label>
                                <select class="form-select" id="mesa-afectada">
                                    <option value="">Seleccione la mesa...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Nivel de Urgencia</label>
                        <div class="urgency-selector">
                            <div class="urgency-option" data-urgency="baja">
                                <i class="fas fa-info-circle text-info fa-2x mb-2"></i>
                                <h6>Baja</h6>
                                <small>No afecta el proceso</small>
                            </div>
                            <div class="urgency-option" data-urgency="media">
                                <i class="fas fa-exclamation-triangle text-warning fa-2x mb-2"></i>
                                <h6>Media</h6>
                                <small>Requiere atención</small>
                            </div>
                            <div class="urgency-option" data-urgency="alta">
                                <i class="fas fa-exclamation-circle text-danger fa-2x mb-2"></i>
                                <h6>Alta</h6>
                                <small>Afecta el proceso</small>
                            </div>
                            <div class="urgency-option" data-urgency="critica">
                                <i class="fas fa-fire text-danger fa-2x mb-2"></i>
                                <h6>Crítica</h6>
                                <small>Emergencia electoral</small>
                            </div>
                        </div>
                        <input type="hidden" id="severidad" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Descripción Detallada de la Incidencia</label>
                        <textarea class="form-control" id="descripcion" rows="4" required
                                placeholder="Describa detalladamente la incidencia: qué pasó, cuándo, dónde, quiénes estuvieron involucrados, qué medidas se tomaron..."></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Personas Involucradas</label>
                                <textarea class="form-control" id="personas-involucradas" rows="2"
                                        placeholder="Nombres, roles o descripción de las personas involucradas..."></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Medidas Tomadas</label>
                                <textarea class="form-control" id="medidas-tomadas" rows="2"
                                        placeholder="Qué acciones se tomaron para resolver o mitigar la incidencia..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Evidencia (Fotos, Videos, Documentos)</label>
                        <div class="photo-capture" onclick="document.getElementById('evidence-input').click()">
                            <i class="fas fa-camera fa-3x text-muted mb-3"></i>
                            <h6>Capturar o Subir Evidencia</h6>
                            <p class="text-muted mb-0">Fotos, videos o documentos que respalden el reporte</p>
                        </div>
                        <input type="file" id="evidence-input" accept="image/*,video/*,.pdf,.doc,.docx" multiple style="display: none;" onchange="handleEvidenceUpload(event)">
                        <div id="evidence-previews" class="mt-3"></div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="notificar-coordinadores" checked>
                                <label class="form-check-label" for="notificar-coordinadores">
                                    <strong>Notificar inmediatamente a coordinadores</strong>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="incluir-ubicacion" checked>
                                <label class="form-check-label" for="incluir-ubicacion">
                                    <strong>Incluir ubicación GPS</strong>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="button" class="btn btn-secondary me-3" onclick="limpiarFormularioIncidencia()">
                            <i class="fas fa-times me-2"></i>Limpiar
                        </button>
                        <button type="submit" class="btn btn-danger btn-lg">
                            <i class="fas fa-exclamation-triangle me-2"></i>Reportar Incidencia
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Lista de Incidencias -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        Historial de Incidencias
                    </h5>
                </div>
                <div class="card-body">
                    <div class="incident-timeline" id="incidencias-timeline">
                        <!-- Las incidencias se cargarán dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block role_scripts %}
<script>
let selectedUrgency = null;
let uploadedEvidence = [];

document.addEventListener('DOMContentLoaded', function() {
    console.log('Página de incidencias cargada');
    cargarMesasDisponibles();
    cargarIncidenciasExistentes();
    
    // Event listeners
    document.getElementById('incidencia-form').addEventListener('submit', handleIncidenciaSubmit);
    
    // Urgency selector
    document.querySelectorAll('.urgency-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.urgency-option').forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            selectedUrgency = this.dataset.urgency;
            document.getElementById('severidad').value = selectedUrgency;
            
            // Mostrar alerta si es crítica
            if (selectedUrgency === 'critica') {
                document.getElementById('emergency-alert').style.display = 'block';
            }
        });
    });
});

function cargarMesasDisponibles() {
    const mesaSelect = document.getElementById('mesa-afectada');
    const mesas = ['001-A', '001-B', '002-A', '002-B', '003-A'];
    
    mesas.forEach(mesa => {
        const option = document.createElement('option');
        option.value = mesa;
        option.textContent = `Mesa ${mesa}`;
        mesaSelect.appendChild(option);
    });
}

function reporteRapido(tipo) {
    // Pre-llenar formulario con tipo seleccionado
    document.getElementById('tipo-incidencia').value = tipo;
    
    // Scroll al formulario
    document.getElementById('incidencia-form').scrollIntoView({ 
        behavior: 'smooth' 
    });
    
    // Highlight del formulario
    const form = document.querySelector('.incidencia-form');
    form.style.boxShadow = '0 0 20px rgba(220, 38, 38, 0.3)';
    setTimeout(() => {
        form.style.boxShadow = '';
    }, 2000);
}

function handleEvidenceUpload(event) {
    const files = event.target.files;
    const previewContainer = document.getElementById('evidence-previews');
    
    Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const evidenceDiv = document.createElement('div');
            evidenceDiv.className = 'd-inline-block position-relative me-2 mb-2';
            
            if (file.type.startsWith('image/')) {
                evidenceDiv.innerHTML = `
                    <img src="${e.target.result}" class="photo-preview" alt="Evidencia" style="max-width: 150px; max-height: 150px; border-radius: 8px;">
                    <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0" 
                            onclick="removeEvidence(this)" style="transform: translate(50%, -50%);">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            } else {
                evidenceDiv.innerHTML = `
                    <div class="border rounded p-3" style="width: 150px; height: 100px; display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
                        <div class="text-center">
                            <i class="fas fa-file fa-2x text-muted mb-1"></i>
                            <small class="d-block text-truncate">${file.name}</small>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0" 
                            onclick="removeEvidence(this)" style="transform: translate(50%, -50%);">
                        <i class="fas fa-times"></i>
                    </button>
                `;
            }
            
            previewContainer.appendChild(evidenceDiv);
            uploadedEvidence.push({
                name: file.name,
                type: file.type,
                data: e.target.result
            });
        };
        reader.readAsDataURL(file);
    });
}

function removeEvidence(button) {
    const evidenceDiv = button.parentElement;
    const index = Array.from(evidenceDiv.parentElement.children).indexOf(evidenceDiv);
    uploadedEvidence.splice(index, 1);
    evidenceDiv.remove();
}

function handleIncidenciaSubmit(event) {
    event.preventDefault();
    
    if (!selectedUrgency) {
        showNotification('Debe seleccionar el nivel de urgencia', 'warning');
        return;
    }
    
    const formData = {
        reportado_por: 5, // Laura González
        tipo_incidencia: document.getElementById('tipo-incidencia').value,
        mesa_id: document.getElementById('mesa-afectada').value,
        descripcion: document.getElementById('descripcion').value,
        severidad: selectedUrgency,
        personas_involucradas: document.getElementById('personas-involucradas').value,
        medidas_tomadas: document.getElementById('medidas-tomadas').value,
        evidencia: uploadedEvidence,
        notificar_coordinadores: document.getElementById('notificar-coordinadores').checked,
        incluir_ubicacion: document.getElementById('incluir-ubicacion').checked
    };
    
    // Obtener ubicación si se solicitó
    if (formData.incluir_ubicacion && navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                formData.ubicacion_gps_lat = position.coords.latitude;
                formData.ubicacion_gps_lng = position.coords.longitude;
                enviarIncidencia(formData);
            },
            function(error) {
                console.warn('Error obteniendo ubicación:', error);
                enviarIncidencia(formData);
            }
        );
    } else {
        enviarIncidencia(formData);
    }
}

function enviarIncidencia(data) {
    // Mostrar indicador de envío
    const submitBtn = document.querySelector('#incidencia-form button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
    submitBtn.disabled = true;
    
    // Simular envío
    setTimeout(() => {
        if (data.severidad === 'critica' || data.severidad === 'alta') {
            showNotification('¡INCIDENCIA CRÍTICA REPORTADA! Los coordinadores han sido notificados inmediatamente.', 'warning');
            document.getElementById('emergency-alert').style.display = 'block';
        } else {
            showNotification('Incidencia reportada exitosamente', 'success');
        }
        
        // Restaurar botón
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
        // Limpiar formulario
        limpiarFormularioIncidencia();
        
        // Recargar lista
        setTimeout(() => {
            cargarIncidenciasExistentes();
        }, 1000);
    }, 2000);
}

function cargarIncidenciasExistentes() {
    const incidenciasDemo = [
        {
            id: 1,
            tipo: 'falla_tecnica',
            descripcion: 'Problema con el sistema de identificación biométrica en mesa 001-A',
            severidad: 'media',
            hora: '09:15 AM',
            estado: 'en_proceso'
        },
        {
            id: 2,
            tipo: 'material_faltante',
            descripcion: 'Falta de bolígrafos en mesa 002-B',
            severidad: 'baja',
            hora: '10:30 AM',
            estado: 'resuelto'
        }
    ];
    
    mostrarIncidencias(incidenciasDemo);
}

function mostrarIncidencias(incidencias) {
    const container = document.getElementById('incidencias-timeline');
    
    if (incidencias.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                <h6>No hay incidencias reportadas</h6>
                <p>¡Excelente! El proceso electoral transcurre sin incidencias</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = incidencias.map(inc => `
        <div class="card mb-3 border-${getUrgencyColor(inc.severidad)}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="card-title">
                            <span class="badge bg-${getUrgencyColor(inc.severidad)} me-2">${inc.severidad.toUpperCase()}</span>
                            <span class="badge bg-${getEstadoColor(inc.estado)} me-2">${inc.estado.replace('_', ' ').toUpperCase()}</span>
                            ${getTipoIncidenciaDisplayName(inc.tipo)}
                        </h6>
                        <p class="card-text">${inc.descripcion}</p>
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>${inc.hora}
                        </small>
                    </div>
                    <div class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="verDetalleIncidencia(${inc.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="seguimientoIncidencia(${inc.id})">
                            <i class="fas fa-comments"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function getUrgencyColor(urgency) {
    const colors = {
        'baja': 'info',
        'media': 'warning',
        'alta': 'danger',
        'critica': 'dark'
    };
    return colors[urgency] || 'secondary';
}

function getEstadoColor(estado) {
    const colors = {
        'reportado': 'primary',
        'en_proceso': 'warning',
        'resuelto': 'success',
        'cerrado': 'secondary'
    };
    return colors[estado] || 'secondary';
}

function getTipoIncidenciaDisplayName(tipo) {
    const nombres = {
        'falla_tecnica': 'Falla Técnica',
        'irregularidad_votacion': 'Irregularidad en Votación',
        'problema_seguridad': 'Problema de Seguridad',
        'alteracion_orden': 'Alteración del Orden',
        'material_faltante': 'Material Faltante',
        'comportamiento_inadecuado': 'Comportamiento Inadecuado',
        'intento_fraude': 'Intento de Fraude',
        'violacion_secreto': 'Violación del Secreto',
        'coaccion_votante': 'Coacción a Votantes',
        'otro': 'Otro'
    };
    return nombres[tipo] || tipo;
}

function limpiarFormularioIncidencia() {
    document.getElementById('incidencia-form').reset();
    document.querySelectorAll('.urgency-option').forEach(opt => opt.classList.remove('selected'));
    selectedUrgency = null;
    uploadedEvidence = [];
    document.getElementById('evidence-previews').innerHTML = '';
    document.getElementById('severidad').value = '';
    document.getElementById('emergency-alert').style.display = 'none';
}

function dismissEmergencyAlert() {
    document.getElementById('emergency-alert').style.display = 'none';
}

function verDetalleIncidencia(id) {
    showNotification('Abriendo detalle de incidencia...', 'info');
}

function seguimientoIncidencia(id) {
    showNotification('Abriendo seguimiento de incidencia...', 'info');
}

function showNotification(mensaje, tipo = 'info') {
    const alertClass = {
        'success': 'alert-success',
        'warning': 'alert-warning',
        'error': 'alert-danger',
        'info': 'alert-info'
    }[tipo];
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    notification.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}
</script>
{% endblock %}