{% extends "base.html" %}
{% block title %}Dashboard Testigo Electoral - Sistema Electoral Caquetá{% endblock %}

{% block extra_styles %}
<style>
    :root {
        --testigo-primary: #06b6d4;
        --testigo-secondary: #0891b2;
        --testigo-accent: #10b981;
    }

    .navbar-testigo {
        background: linear-gradient(135deg, var(--testigo-primary) 0%, var(--testigo-secondary) 100%);
    }

    .card-testigo {
        border-left: 4px solid var(--testigo-primary);
        transition: all 0.3s;
    }

    .card-testigo:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(6, 182, 212, 0.3);
    }

    .btn-testigo {
        background: linear-gradient(135deg, var(--testigo-primary) 0%, var(--testigo-secondary) 100%);
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-testigo:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(6, 182, 212, 0.4);
        color: white;
    }

    .stat-card-testigo {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-left: 4px solid var(--testigo-primary);
    }

    .form-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .secondary-actions {
        background: #f8fafc;
        border-radius: 12px;
        padding: 20px;
        margin-top: 30px;
    }

    .quick-action-btn {
        width: 100%;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        border: 2px solid #e2e8f0;
        background: white;
        transition: all 0.3s;
    }

    .quick-action-btn:hover {
        border-color: var(--testigo-primary);
        background: #f0f9ff;
        transform: translateX(5px);
    }

    .progress-bar-testigo {
        background: linear-gradient(135deg, var(--testigo-primary) 0%, var(--testigo-accent) 100%);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card-testigo card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2><i class="fas fa-user-check me-2"></i>Dashboard Testigo Electoral</h2>
                            <p class="mb-0 text-muted">Mesa Asignada: <strong id="mesaAsignada">001-A</strong> | Puesto: <strong id="puestoVotacion">Colegio Nacional</strong></p>
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-success fs-6">Activo</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas Rápidas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card-testigo">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">Votos Registrados</small>
                        <h3 class="mb-0" id="votosRegistrados">0</h3>
                    </div>
                    <i class="fas fa-vote-yea fa-2x text-primary"></i>
                </div>
                <div class="progress mt-2" style="height: 6px;">
                    <div class="progress-bar progress-bar-testigo" id="progressVotos" style="width: 0%"></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card-testigo">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">Votantes Habilitados</small>
                        <h3 class="mb-0" id="votantesHabilitados">350</h3>
                    </div>
                    <i class="fas fa-users fa-2x text-info"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card-testigo">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">Participación</small>
                        <h3 class="mb-0" id="participacion">0%</h3>
                    </div>
                    <i class="fas fa-chart-line fa-2x text-success"></i>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card-testigo">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted">Estado Mesa</small>
                        <h3 class="mb-0"><span class="badge bg-warning">En Proceso</span></h3>
                    </div>
                    <i class="fas fa-clipboard-check fa-2x text-warning"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- SECCIÓN PRINCIPAL: CAPTURA DE DATOS -->
    <div class="row">
        <div class="col-md-8">
            <div class="form-section">
                <h4 class="mb-4"><i class="fas fa-edit me-2"></i>Captura de Datos - Registro de Votación</h4>
                
                <!-- Tabs para diferentes formularios -->
                <ul class="nav nav-tabs mb-4" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#registroVotos">
                            <i class="fas fa-vote-yea me-2"></i>Registro de Votos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#capturaE14">
                            <i class="fas fa-camera me-2"></i>Captura E14
                        </a>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Tab: Registro de Votos -->
                    <div class="tab-pane fade show active" id="registroVotos">
                        <form id="formRegistroVoto">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Candidato</label>
                                    <select class="form-select" id="candidato" required>
                                        <option value="">Seleccionar candidato...</option>
                                        <option value="1">Candidato 1 - Partido A</option>
                                        <option value="2">Candidato 2 - Partido B</option>
                                        <option value="3">Candidato 3 - Partido C</option>
                                        <option value="voto_blanco">Voto en Blanco</option>
                                        <option value="voto_nulo">Voto Nulo</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Número de Votos</label>
                                    <input type="number" class="form-control" id="numeroVotos" value="1" min="1" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Observaciones (opcional)</label>
                                <textarea class="form-control" id="observacionVoto" rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-testigo">
                                <i class="fas fa-save me-2"></i>Registrar Voto
                            </button>
                        </form>
                    </div>

                    <!-- Tab: Captura E14 -->
                    <div class="tab-pane fade" id="capturaE14">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Captura E14:</strong> Tome foto del formulario físico y digite los datos
                        </div>
                        
                        <div class="text-center">
                            <a href="/testigo/e14" class="btn btn-testigo btn-lg">
                                <i class="fas fa-camera me-2"></i>Ir a Captura E14
                            </a>
                            <p class="text-muted mt-3">
                                <small>Fotografíe el formulario E14 físico y digite los datos para enviar</small>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PANEL LATERAL: Acciones Rápidas -->
        <div class="col-md-4">
            <div class="form-section">
                <h5 class="mb-3"><i class="fas fa-bolt me-2"></i>Acciones Rápidas</h5>
                <button class="btn btn-testigo w-100 mb-2" onclick="abrirMesa()">
                    <i class="fas fa-door-open me-2"></i>Abrir Mesa
                </button>
                <button class="btn btn-testigo w-100 mb-2" onclick="cerrarMesa()">
                    <i class="fas fa-door-closed me-2"></i>Cerrar Mesa
                </button>
                <button class="btn btn-testigo w-100 mb-2" onclick="verResumen()">
                    <i class="fas fa-chart-bar me-2"></i>Ver Resumen
                </button>
                <button class="btn btn-testigo w-100" onclick="exportarDatos()">
                    <i class="fas fa-download me-2"></i>Exportar Datos
                </button>
            </div>

            <!-- Resumen de Votos -->
            <div class="form-section mt-3">
                <h5 class="mb-3"><i class="fas fa-list me-2"></i>Resumen de Votos</h5>
                <div id="resumenVotos">
                    <p class="text-muted text-center">No hay votos registrados aún</p>
                </div>
            </div>
        </div>
    </div>

    <!-- SECCIÓN SECUNDARIA: Observaciones e Incidencias -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="secondary-actions">
                <h4 class="mb-4"><i class="fas fa-eye me-2"></i>Observaciones e Incidencias</h4>
                <p class="text-muted mb-4">Registra observaciones del proceso electoral e incidencias que requieran atención</p>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <button class="quick-action-btn" onclick="window.location.href='/testigo/observaciones'">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-clipboard-list fa-2x text-primary me-3"></i>
                                <div class="text-start">
                                    <h6 class="mb-0">Registrar Observación</h6>
                                    <small class="text-muted">Observaciones del proceso electoral</small>
                                </div>
                            </div>
                        </button>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button class="quick-action-btn" onclick="window.location.href='/testigo/incidencias'">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exclamation-triangle fa-2x text-warning me-3"></i>
                                <div class="text-start">
                                    <h6 class="mb-0">Reportar Incidencia</h6>
                                    <small class="text-muted">Incidencias que requieren atención</small>
                                </div>
                            </div>
                        </button>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button class="quick-action-btn" onclick="window.location.href='/testigo/reportes'">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-alt fa-2x text-info me-3"></i>
                                <div class="text-start">
                                    <h6 class="mb-0">Ver Reportes</h6>
                                    <small class="text-muted">Historial de observaciones e incidencias</small>
                                </div>
                            </div>
                        </button>
                    </div>
                    <div class="col-md-6 mb-3">
                        <button class="quick-action-btn" onclick="window.location.href='/testigo/resultados'">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-chart-pie fa-2x text-success me-3"></i>
                                <div class="text-start">
                                    <h6 class="mb-0">Ver Resultados</h6>
                                    <small class="text-muted">Resultados preliminares de la mesa</small>
                                </div>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Cargar datos de la mesa asignada
document.addEventListener('DOMContentLoaded', function() {
    cargarDatosMesa();
});

async function cargarDatosMesa() {
    try {
        const token = localStorage.getItem('token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        // Cargar datos de la mesa asignada
        const response = await fetch('/api/testigo/mesa-asignada', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                actualizarEstadisticas(data.mesa);
            }
        }
    } catch (error) {
        console.error('Error cargando datos:', error);
    }
}

function actualizarEstadisticas(mesa) {
    document.getElementById('votosRegistrados').textContent = mesa.votos_registrados || 0;
    document.getElementById('votantesHabilitados').textContent = mesa.votantes_habilitados || 350;
    
    const participacion = mesa.votantes_habilitados > 0 
        ? Math.round((mesa.votos_registrados / mesa.votantes_habilitados) * 100) 
        : 0;
    
    document.getElementById('participacion').textContent = participacion + '%';
    document.getElementById('progressVotos').style.width = participacion + '%';
}

// Registro de voto
document.getElementById('formRegistroVoto').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const voto = {
        candidato_id: document.getElementById('candidato').value,
        numero_votos: document.getElementById('numeroVotos').value,
        observacion: document.getElementById('observacionVoto').value
    };
    
    try {
        const token = localStorage.getItem('token');
        const response = await fetch('/api/testigo/registrar-voto', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(voto)
        });
        
        if (response.ok) {
            alert('Voto registrado exitosamente');
            this.reset();
            cargarDatosMesa();
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al registrar voto');
    }
});

// Funciones de acciones rápidas
function abrirMesa() {
    if (confirm('¿Desea abrir la mesa de votación?')) {
        alert('Mesa abierta exitosamente');
    }
}

function cerrarMesa() {
    if (confirm('¿Desea cerrar la mesa de votación?')) {
        alert('Mesa cerrada exitosamente');
    }
}

function verResumen() {
    window.location.href = '/testigo/resumen';
}

function exportarDatos() {
    window.location.href = '/api/testigo/exportar-datos';
}
</script>
{% endblock %}
